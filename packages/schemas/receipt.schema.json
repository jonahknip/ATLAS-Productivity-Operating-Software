{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://atlas.dev/schemas/receipt.schema.json",
  "title": "ATLAS Receipt",
  "description": "Complete audit record of a request execution",
  "type": "object",
  "required": [
    "receipt_id",
    "timestamp_utc",
    "status",
    "user_input",
    "models_attempted",
    "tool_calls",
    "changes",
    "undo"
  ],
  "properties": {
    "receipt_id": {
      "type": "string",
      "format": "uuid",
      "description": "Unique identifier for this receipt"
    },
    "timestamp_utc": {
      "type": "string",
      "format": "date-time",
      "description": "When the request was processed"
    },
    "profile_id": {
      "type": ["string", "null"],
      "description": "User profile ID if applicable"
    },
    "status": {
      "type": "string",
      "enum": ["SUCCESS", "PARTIAL", "FAILED", "PENDING_CONFIRM"],
      "description": "Overall execution status"
    },
    "user_input": {
      "type": "string",
      "description": "Original user input"
    },
    "models_attempted": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/ModelAttempt"
      },
      "description": "Record of all model invocations"
    },
    "intent_final": {
      "oneOf": [
        { "$ref": "intent.schema.json" },
        { "type": "null" }
      ],
      "description": "Final parsed intent"
    },
    "tool_calls": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/ToolCall"
      },
      "description": "Record of tool invocations"
    },
    "changes": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/Change"
      },
      "description": "State changes made"
    },
    "undo": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/UndoStep"
      },
      "description": "Steps to reverse changes"
    },
    "warnings": {
      "type": "array",
      "items": { "type": "string" },
      "default": []
    },
    "errors": {
      "type": "array",
      "items": { "type": "string" },
      "default": []
    }
  },
  "$defs": {
    "ModelAttempt": {
      "type": "object",
      "required": ["provider", "model", "attempt_number", "success"],
      "properties": {
        "provider": {
          "type": "string",
          "description": "Provider name (e.g., 'ollama', 'openai')"
        },
        "model": {
          "type": "string",
          "description": "Model identifier"
        },
        "attempt_number": {
          "type": "integer",
          "minimum": 1
        },
        "success": {
          "type": "boolean"
        },
        "fallback_trigger": {
          "type": ["string", "null"],
          "enum": [
            "INVALID_JSON",
            "VALIDATION_ERROR",
            "TIMEOUT",
            "RATE_LIMIT",
            "PROVIDER_DOWN",
            "CAPABILITY_MISMATCH",
            null
          ]
        },
        "latency_ms": {
          "type": ["integer", "null"]
        },
        "timestamp_utc": {
          "type": "string",
          "format": "date-time"
        }
      }
    },
    "ToolCall": {
      "type": "object",
      "required": ["tool_name", "status"],
      "properties": {
        "tool_name": {
          "type": "string"
        },
        "args": {
          "type": "object",
          "additionalProperties": true
        },
        "status": {
          "type": "string",
          "enum": ["PENDING_CONFIRM", "OK", "FAILED", "SKIPPED"]
        },
        "result": {},
        "error": {
          "type": ["string", "null"]
        },
        "timestamp_utc": {
          "type": "string",
          "format": "date-time"
        }
      }
    },
    "Change": {
      "type": "object",
      "required": ["entity_type", "entity_id", "action"],
      "properties": {
        "entity_type": {
          "type": "string",
          "description": "e.g., 'task', 'calendar_block', 'workflow'"
        },
        "entity_id": {
          "type": "string"
        },
        "action": {
          "type": "string",
          "description": "e.g., 'created', 'updated', 'deleted'"
        },
        "before": {
          "type": ["object", "null"]
        },
        "after": {
          "type": ["object", "null"]
        }
      }
    },
    "UndoStep": {
      "type": "object",
      "required": ["tool_name", "args", "description"],
      "properties": {
        "tool_name": {
          "type": "string"
        },
        "args": {
          "type": "object",
          "additionalProperties": true
        },
        "description": {
          "type": "string"
        }
      }
    }
  }
}
